{% extends "base.html" %}

{% block title %}Avito Agent - История чатов{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1200px; padding: 0;">
    <h2 style="color: #4CAF50; margin-bottom: 30px; border-left: 5px solid #4CAF50; padding-left: 15px;">История чатов</h2>
    
    <div id="chat-history-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
        <div style="color:#888;">Загрузка...</div>
    </div>
    
    <div id="no-chats-message" style="text-align: center; color: #888; margin-top: 50px; display: none;">
        <i class="fas fa-history fa-3x mb-3"></i>
        <p>У вас пока нет чатов</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadChatHistory() {
        try {
            const response = await fetch('/api/chats');
            const chats = await response.json();
            
            const container = document.getElementById('chat-history-container');
            const noChatsMessage = document.getElementById('no-chats-message');
            
            if (chats.length === 0) {
                container.style.display = 'none';
                noChatsMessage.style.display = 'block';
                return;
            }
            
            container.innerHTML = '';
            
            chats.forEach(chat => {
                let chatType = 'Поиск';
                let chatTypeColor = '#4CAF50';
                let link = `/?chat_id=${chat.id}`;

                if (chat.title && (chat.title.includes('Deep Research') || chat.title.includes('Глубок'))) {
                    chatType = 'Deep Research';
                    chatTypeColor = '#2196F3';
                    link = `/deep_research?chat_id=${chat.id}`;
                }
                
                const chatCard = document.createElement('div');
                chatCard.className = `card bg-dark text-white h-100 shadow-sm`;
                chatCard.style.cursor = 'pointer';
                chatCard.style.border = '1px solid #333';
                chatCard.style.transition = 'transform 0.2s';
                
                chatCard.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="badge" style="background-color: ${chatTypeColor}">${chatType}</span>
                            <small class="text-muted">${new Date(chat.created_at).toLocaleDateString()}</small>
                        </div>
                        <h5 class="card-title text-truncate">${chat.title}</h5>
                        <p class="card-text text-muted small text-truncate">
                             <i class="far fa-clock me-1"></i> ${new Date(chat.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </p>
                    </div>
                `;
                
                chatCard.onclick = () => {
                    window.location.href = link;
                };
                
                container.appendChild(chatCard);
            });
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }
    
    window.onload = loadChatHistory;
</script>
{% endblock %}