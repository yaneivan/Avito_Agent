{% extends "base.html" %}

{% block title %}Avito Agent - –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑{% endblock %}

{% block content %}
<div class="container" style="padding: 0;">
    <div class="header" style="text-align: center; padding: 10px 0; border-bottom: 1px solid #333; color: #4CAF50; margin-bottom: 20px;">
        <h1><i class="fas fa-brain me-2"></i>–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞</h1>
    </div>

    <!-- –ß–∞—Ç -->
    <div id="chat-section" class="chat-container" style="display: flex; flex-direction: column; background: #1a1a1a; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid #333; margin-bottom: 20px;">
        <div class="chat-header" style="padding: 15px 20px; background: #222; border-bottom: 1px solid #333; font-weight: bold;">
            <span>–ß–∞—Ç —Å –∞–≥–µ–Ω—Ç–æ–º</span>
        </div>
        <div id="chat-messages" class="chat-messages" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; max-height: 50vh; min-height: 300px;">
        </div>
        <div class="input-area" style="padding: 20px; background: #1a1a1a; border-top: 1px solid #333;">
            <div class="input-container" style="display: flex; gap: 10px;">
                <input type="text" id="inp" placeholder="–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∞–≥–µ–Ω—Ç–∞..." style="flex: 1; padding: 12px; background: #2d2d2d; border: 1px solid #444; border-radius: 6px; color: white; outline: none;">
                <button id="send-btn" class="btn btn-success" style="font-weight: bold;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div id="status-results-section" style="margin-top: 20px;">
        <div id="status-indicator" style="padding: 15px; background: #222; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #e0e0e0; font-weight: bold;" id="status-text">–û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã...</div>
            <div id="progress-bar" style="width: 30%; height: 10px; background: #333; border-radius: 5px; overflow: hidden;">
                <div id="progress-fill" style="height: 100%; width: 0%; background: #4CAF50; transition: width 0.3s;"></div>
            </div>
        </div>
        <div id="analysis-summary" style="margin-bottom: 30px; padding: 20px; background: #1e1e1e; border-radius: 8px; line-height: 1.6;"></div>
        <div id="top-items-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    let currentStage = 'interview';
    let deepResearchId = null;
    let deepHistory = [];
    let currentChatId = null;

    const chatMessages = document.getElementById('chat-messages');
    const inp = document.getElementById('inp');
    const sendBtn = document.getElementById('send-btn');
    const statusText = document.getElementById('status-text');
    const progressBar = document.getElementById('progress-fill');
    const analysisSummary = document.getElementById('analysis-summary');
    const topItemsGrid = document.getElementById('top-items-grid');

    function addMsg(role, text, isHtml = false) {
        const div = document.createElement('div');
        div.className = `msg msg-${role}`;
        div.style.cssText = `padding: 12px 16px; border-radius: 8px; max-width: 80%; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word;`;
        if (role === 'user') {
            div.style.cssText += `background: #2d2d2d; align-self: flex-end; color: white; border-bottom-right-radius: 2px;`;
        } else {
            div.style.cssText += `background: #262626; align-self: flex-start; border-left: 3px solid #4CAF50; border-bottom-left-radius: 2px;`;
        }
        if (isHtml) div.innerHTML = text; else div.innerText = text;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function updateStatus(text, progress = 0) {
        statusText.textContent = text;
        progressBar.style.width = `${progress}%`;
    }

    function showStage(stage) {
        currentStage = stage;
        const stageNames = {'interview': '–ò–Ω—Ç–µ—Ä–≤—å—é', 'parsing': '–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö', 'analysis': '–ê–Ω–∞–ª–∏–∑', 'results': '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã'};
        updateStatus(`${stageNames[stage] || stage}`, getProgressForStage(stage));
    }

    function getProgressForStage(stage) {
        switch(stage) {
            case 'interview': return 25;
            case 'parsing': return 50;
            case 'analysis': return 75;
            case 'results': return 90;
            default: return 0;
        }
    }

    async function init() {
        const urlParams = new URLSearchParams(window.location.search);
        const chatIdParam = urlParams.get('chat_id');
        if (chatIdParam) {
            currentChatId = chatIdParam;
            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º, —Å–≤—è–∑–∞–Ω –ª–∏ —á–∞—Ç —Å —Å–µ—Å—Å–∏–µ–π –≥–ª—É–±–æ–∫–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
                const researchRes = await fetch(`/api/chats/${currentChatId}/deep_research_session`);
                let researchData = null;

                if (researchRes.ok) {
                    researchData = await researchRes.json();
                }

                // –ï—Å–ª–∏ —á–∞—Ç –Ω–µ —Å–≤—è–∑–∞–Ω —Å —Å–µ—Å—Å–∏–µ–π –≥–ª—É–±–æ–∫–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –æ–±—ã—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–∏—Å–∫–∞
                if (!researchData || !researchData.id) {
                    window.location.href = `/?chat_id=${currentChatId}`;
                    return;
                }

                const res = await fetch(`/api/chats/${currentChatId}`);
                if (res.ok) {
                    const data = await res.json();
                    chatMessages.innerHTML = '';
                    deepHistory = [];
                    data.messages.forEach(msg => {
                        if (msg.role !== 'system') {
                            addMsg(msg.role, marked.parse(msg.content), true);
                            deepHistory.push({role: msg.role, content: msg.content});
                        }
                    });

                    if (researchData && researchData.id) {
                        deepResearchId = researchData.id;

                        // –ü—Ä–æ–≤–µ—Ä–∏–º —Å—Ç–∞—Ç—É—Å —Å–µ—Å—Å–∏–∏ –∏ –ø–æ–∫–∞–∂–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –≥–æ—Ç–æ–≤—ã
                        const statusRes = await fetch(`/api/deep_research/status/${deepResearchId}`);
                        if (statusRes.ok) {
                            const statusData = await statusRes.json();

                            // –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                            if (statusData.status === 'completed') {
                                showStage('results');
                                updateStatus('–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω', 100);

                                if (statusData.summary) {
                                    analysisSummary.innerHTML = marked.parse(statusData.summary);
                                }

                                const itemsRes = await fetch(`/api/deep_research/items/${deepResearchId}`);
                                if (itemsRes.ok) {
                                    const items = await itemsRes.json();
                                    renderTopItemsGrid(items);
                                }
                            } else {
                                // –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç–∞–¥–∏—é
                                if (statusData.stage === 'parsing') {
                                    showStage('parsing');
                                } else if (statusData.stage === 'analysis') {
                                    showStage('analysis');
                                } else if (statusData.stage === 'results') {
                                    showStage('results');
                                } else {
                                    showStage('interview');
                                }
                            }
                        }
                    }
                }
            } catch (e) { console.error(e); }
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç chat_id –≤ URL, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ —á–µ—Ä–µ–∑ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
            try {
                const welcome = "–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –≤–∞–º –ø—Ä–æ–≤–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞.";
                addMsg('assistant', welcome);
                deepHistory.push({role: "assistant", content: welcome});
                updateStatus('–ò–Ω—Ç–µ—Ä–≤—å—é - —Å–±–æ—Ä —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π', 25);

                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –≥–ª—É–±–æ–∫–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
                const res = await fetch('/api/deep_research/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        history: deepHistory,
                        research_session_id: deepResearchId || null,
                        chat_id: currentChatId || null
                    })
                });
                const data = await res.json();
                if (data.research_id) {
                    deepResearchId = data.research_id;

                    // –ü–æ–ª—É—á–∞–µ–º —á–∞—Ç, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å —ç—Ç–æ–π —Å–µ—Å—Å–∏–µ–π
                    const chatRes = await fetch(`/api/deep_research/get_chat_by_research/${deepResearchId}`);
                    if (chatRes.ok) {
                        const chatData = await chatRes.json();
                        currentChatId = chatData.chat_id;
                        window.history.pushState({}, '', `?chat_id=${currentChatId}`);
                    }
                }
            } catch (e) {
                console.error(e);
                const welcome = "–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –≤–∞–º –ø—Ä–æ–≤–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞.";
                addMsg('assistant', welcome);
                deepHistory.push({role: "assistant", content: welcome});
                showStage('interview');
            }
        }
    }

    async function sendMessage() {
        const txt = inp.value.trim();
        if (!txt) return;
        inp.value = ''; inp.disabled = true; sendBtn.disabled = true;

        addMsg('user', txt);
        deepHistory.push({role: "user", content: txt});

        try {
            const res = await fetch('/api/deep_research/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    history: deepHistory,
                    research_session_id: deepResearchId || null,
                    chat_id: currentChatId || null
                })
            });
            const data = await res.json();

            if (data.type === 'schema_confirmed') {
                addMsg('assistant', data.message);
                deepResearchId = data.research_id;
                showStage('parsing');
                startParsingPhase();
            } else if (data.type === 'interview') {
                let msgText = data.message;
                if (data.stage === 'schema_agreement') {
                    msgText += `\n\n‚úÖ **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è —Å–æ–±—Ä–∞–Ω—ã!**\n–ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞: *${data.criteria_summary}*`;
                    msgText += "\n\nüìã **–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–∞—è —Å—Ö–µ–º–∞:**\n" + (typeof data.schema_proposal === 'string' ? data.schema_proposal : JSON.stringify(data.schema_proposal, null, 2));
                    msgText += "\n\n–ù–∞–ø–∏—à–∏—Ç–µ **'–î–∞'** –∏–ª–∏ **'–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é'**, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–æ–∏—Å–∫.";
                }
                addMsg('assistant', marked.parse(msgText), true);
                deepHistory.push({role: "assistant", content: msgText});
                if (data.research_id) deepResearchId = data.research_id;
            } else if (data.type === 'schema_proposal') {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å—Ö–µ–º—ã
                let msgText = data.message;
                addMsg('assistant', marked.parse(msgText), true);
                deepHistory.push({role: "assistant", content: data.message});
                if (data.research_id) deepResearchId = data.research_id;
            } else if (data.type === 'search_started') {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞ –ø–æ–∏—Å–∫–∞
                addMsg('assistant', data.message);
                deepResearchId = data.research_id;
                showStage('parsing');
                updateStatus('–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö...', 50);
                startParsingPhase();
            } else if (data.type === 'waiting_for_results') {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–∂–∏–¥–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                addMsg('assistant', data.message);
                deepResearchId = data.research_id;
                showStage('parsing');
                updateStatus('–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö...', 50);
                waitForResultsAndProcess();
            } else if (data.type === 'error') {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
                addMsg('assistant', `‚ùå ${data.message}`);
            } else if (data.type === 'chat') {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ —á–∞—Ç-–æ—Ç–≤–µ—Ç–∞
                addMsg('assistant', marked.parse(data.message), true);
                deepHistory.push({role: "assistant", content: data.message});
                if (data.research_id) deepResearchId = data.research_id;
            }
        } catch (err) {
            console.error(err);
            addMsg('assistant', '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
        inp.disabled = false; sendBtn.disabled = false; inp.focus();
    }

    sendBtn.addEventListener('click', sendMessage);
    inp.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    async function startParsingPhase() {
        try {
            await fetch(`/api/deep_research/start_parsing?research_id=${deepResearchId}`, {method: 'POST'});
            showStage('parsing');
            setTimeout(() => {
                showStage('analysis');
                fetchAnalysisResults();
            }, 3000);
        } catch (e) { console.error(e); }
    }

    async function waitForResultsAndProcess() {
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Å—Å–∏–∏ –∏ –∑–∞–ø—É—Å–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        const checkStatus = async () => {
            try {
                const response = await fetch(`/api/deep_research/status/${deepResearchId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const statusData = await response.json();

                // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ "processing" –∏–ª–∏ "completed", –∑–Ω–∞—á–∏—Ç –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏–ª–∏ –≥–æ—Ç–æ–≤—ã
                if (statusData.stage === 'parsing' || statusData.stage === 'analysis' || statusData.stage === 'completed' ||
                    statusData.status === 'processing' || statusData.status === 'completed') {
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                    showStage('analysis');
                    fetchAnalysisResults();
                } else {
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(checkStatus, 3000);
                }
            } catch (error) {
                console.error('Error checking research status:', error);
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å
                setTimeout(checkStatus, 3000);
            }
        };

        // –ù–∞—á–∏–Ω–∞–µ–º –æ–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞
        checkStatus();
    }

    async function fetchAnalysisResults() {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∞–Ω–∞–ª–∏–∑–∞
            const statusRes = await fetch(`/api/deep_research/status/${deepResearchId}`);
            const statusData = await statusRes.json();

            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ completed, —Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
            if (statusData.status !== 'completed') {
                await fetch(`/api/deep_research/execute_analysis?research_id=${deepResearchId}`, {method: 'POST'});
            }

            // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã –¥–∞—Ç—å –≤—Ä–µ–º—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É
            await new Promise(resolve => setTimeout(resolve, 1000));

            const sRes = await fetch(`/api/deep_research/status/${deepResearchId}`);
            const sData = await sRes.json();

            if (sData.summary) {
                analysisSummary.innerHTML = marked.parse(sData.summary);
            }

            showStage('results');

            const iRes = await fetch(`/api/deep_research/items/${deepResearchId}`);
            const items = await iRes.json();
            renderTopItemsGrid(items);
        } catch (e) { console.error(e); }
    }

    function renderTopItemsGrid(items) {
        if (!items.length) {
            topItemsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #888;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            return;
        }
        let html = '';
        for (const item of items) {
            // –ü–∞—Ä—Å–∏–º structured_data, –µ—Å–ª–∏ –µ—Å—Ç—å
            let structuredData = {};
            if (item.structured_data) {
                try {
                    structuredData = JSON.parse(item.structured_data);
                } catch (e) {
                    console.error('Error parsing structured_data:', e);
                }
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
            let featuresHtml = '';
            if (Object.keys(structuredData).length > 0) {
                featuresHtml = '<div class="features-list" style="display: none; padding: 10px; background: #2a2a2a; border-top: 1px solid #444;">';
                for (const [key, value] of Object.entries(structuredData)) {
                    featuresHtml += '<div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #444;">' +
                                   '<span style="color: #aaa; font-size: 0.9em;">' + key + ':</span>' +
                                   '<span style="color: #eee; font-size: 0.9em;">' + value + '</span>' +
                                   '</div>';
                }
                featuresHtml += '</div>';
            }

            html += '<div class="card" style="background:#222; border:1px solid #444; overflow: hidden; border-radius: 8px;">' +
                    '<img src="' + (item.image_url || '') + '" style="width:100%; height:150px; object-fit:cover;">' +
                    '<div style="padding:10px;">' +
                    '<div style="color:#4CAF50; font-weight:bold">' + item.price + '</div>' +
                    '<div style="font-size: 0.9rem;"><a href="' + item.url + '" target="_blank" style="color:#eee; text-decoration: none;">' + item.title + '</a></div>' +
                    (Object.keys(structuredData).length > 0 ?
                      '<div class="toggle-features" style="margin-top: 10px; cursor: pointer; color: #4CAF50; display: flex; align-items: center;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === \'none\' ? \'block\' : \'none\';">' +
                      '<i class="fas fa-chevron-down" style="margin-right: 5px; font-size: 0.8em;"></i> –ü–æ–∫–∞–∑–∞—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏' +
                      '</div>' : '') +
                    featuresHtml +
                    '</div>' +
                    '</div>';
        }
        topItemsGrid.innerHTML = html;
    }

    init();
</script>
{% endblock %}