{% extends "base.html" %}

{% block title %}Avito Agent - –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <div class="header" style="text-align: center; padding: 10px 0; border-bottom: 1px solid #333; color: #4CAF50;">
        <h1>–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞</h1>
    </div>

    <!-- Interview Stage -->
    <div id="interview-stage" class="chat-container" style="display: flex; flex-direction: column; background: #1a1a1a; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3); margin-top: 20px;">
        <div class="chat-header" style="padding: 15px 20px; background: #222; border-bottom: 1px solid #333; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
            <span>–ò–Ω—Ç–µ—Ä–≤—å—é - –°–±–æ—Ä —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π</span>
            <div id="current-state" style="font-size: 0.8em; color: #aaa;">–°—Ç–∞–¥–∏—è: –∏–Ω—Ç–µ—Ä–≤—å—é</div>
        </div>
        <div id="chat-messages" class="chat-messages" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; max-height: 50vh;">
            <div class="msg msg-bot" style="padding: 12px 16px; border-radius: 8px; max-width: 80%; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; background: #262626; align-self: flex-start; border-left: 3px solid #4CAF50; border-bottom-left-radius: 2px;">–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –≤–∞–º –ø—Ä–æ–≤–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞. –û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –º–æ–∏ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã —è –º–æ–≥ –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å –≤–∞—à–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏.</div>
        </div>
        <div class="input-area" style="padding: 20px; background: #1a1a1a; border-top: 1px solid #333;">
            <div class="input-container" style="display: flex; gap: 10px;">
                <input type="text" id="inp" placeholder="–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∞–≥–µ–Ω—Ç–∞..." style="flex: 1; padding: 12px; background: #2d2d2d; border: 1px solid #444; border-radius: 6px; color: white; outline: none;">
                <button id="send-btn" class="btn" style="padding: 12px 20px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <button id="finish-interview-btn" class="btn btn-secondary" style="padding: 12px 20px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é</button>
            </div>
        </div>
    </div>


    <!-- Parsing Progress Stage -->
    <div id="parsing-stage" class="hidden progress-container" style="display: none; padding: 20px; text-align: center; margin-top: 20px;">
        <h3>–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Å Avito</h3>
        <p>–°–æ–±–∏—Ä–∞–µ–º 200 –æ–±—ä—è–≤–ª–µ–Ω–∏–π –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞...</p>
        <div class="progress-bar" style="width: 100%; height: 20px; background: #333; border-radius: 10px; overflow: hidden; margin: 10px 0; position: relative;">
            <div id="parsing-progress-fill" class="progress-fill" style="height: 100%; background: #4CAF50; width: 0%; transition: width 0.3s;"></div>
        </div>
        <div id="parsing-status">–°–æ–±—Ä–∞–Ω–æ: <span id="parsed-count">0</span>/200</div>
        <div style="margin-top: 20px;">
            <button id="skip-parsing-btn" class="btn" style="padding: 12px 20px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä</button>
        </div>
    </div>

    <!-- Analysis Results Stage -->
    <div id="results-stage" class="hidden results-container" style="display: none; padding: 20px; overflow-y: auto; margin-top: 20px;">
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</h3>
        <div id="analysis-summary" style="margin: 20px 0; padding: 15px; background: #1e1e1e; border-radius: 8px;"></div>
        <h4>–¢–æ–ø-20 —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º:</h4>
        <div id="top-items-grid" class="results-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // State variables
    let currentStage = 'interview'; // 'interview', 'schema', 'parsing', 'results'
    let deepSearchId = null;
    let deepHistory = [
        {role: "assistant", content: "–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –≤–∞–º –ø—Ä–æ–≤–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞. –û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –º–æ–∏ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã —è –º–æ–≥ –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å –≤–∞—à–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏."}
    ];
    let currentChatId = null;

    // DOM Elements
    const chatMessages = document.getElementById('chat-messages');
    const inp = document.getElementById('inp');
    const sendBtn = document.getElementById('send-btn');
    const finishInterviewBtn = document.getElementById('finish-interview-btn');
    const schemaEditor = document.getElementById('schema-editor');
    const confirmSchemaBtn = document.getElementById('confirm-schema-btn');
    const backToInterviewBtn = document.getElementById('back-to-interview-btn');
    const skipParsingBtn = document.getElementById('skip-parsing-btn');
    const parsingProgressFill = document.getElementById('parsing-progress-fill');
    const parsedCountSpan = document.getElementById('parsed-count');
    const analysisSummary = document.getElementById('analysis-summary');
    const topItemsGrid = document.getElementById('top-items-grid');
    const currentStateElement = document.getElementById('current-state');

    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function createNewChatIfNeeded() {
        if (currentChatId !== null) return; // –£–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç

        try {
            const response = await fetch('/api/chats', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            const newChat = await response.json();
            currentChatId = newChat.id;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞:', error);
        }
    }

    // Add message to chat
    function addMsg(role, text, isHtml = false, reasoning = '', internalThoughts = '', nextAction = '') {
        const div = document.createElement('div');
        div.className = `msg msg-${role}`;
        div.style.cssText = `
            padding: 12px 16px;
            border-radius: 8px;
            max-width: 80%;
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word;
        `;

        if (role === 'user') {
            div.style.cssText += `
                background: #2d2d2d;
                align-self: flex-end;
                color: white;
                border-bottom-right-radius: 2px;
            `;
        } else if (role === 'bot') {
            div.style.cssText += `
                background: #262626;
                align-self: flex-start;
                border-left: 3px solid #4CAF50;
                border-bottom-left-radius: 2px;
            `;
        }

        if (isHtml) {
            div.innerHTML = text;
        } else {
            div.innerText = text;
        }

        // Add expandable reasoning and internal thoughts sections for bot messages
        if (role === 'bot' && (reasoning || internalThoughts || nextAction)) {
            const expandDiv = document.createElement('div');
            expandDiv.style.cssText = `
                margin-top: 8px;
                padding: 8px;
                background: #2a2a2a;
                border-radius: 4px;
                border-left: 2px solid #666;
            `;

            // Reasoning section
            if (reasoning) {
                const reasoningHeader = document.createElement('div');
                reasoningHeader.innerHTML = `
                    <strong style="color: #aaa; font-size: 0.8em; cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">
                        üîç –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è (–∫–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)
                    </strong>
                    <div style="display: none; margin-top: 5px; color: #bbb; font-size: 0.85em; padding: 5px; background: #333; border-radius: 3px;">
                        ${reasoning}
                    </div>
                `;
                expandDiv.appendChild(reasoningHeader);
            }

            // Internal thoughts section
            if (internalThoughts) {
                const thoughtsHeader = document.createElement('div');
                thoughtsHeader.innerHTML = `
                    <strong style="color: #aaa; font-size: 0.8em; cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">
                        üí≠ –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è (–∫–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)
                    </strong>
                    <div style="display: none; margin-top: 5px; color: #bbb; font-size: 0.85em; padding: 5px; background: #333; border-radius: 3px;">
                        ${internalThoughts}
                    </div>
                `;
                expandDiv.appendChild(thoughtsHeader);
            }

            // Next action section
            if (nextAction) {
                const actionHeader = document.createElement('div');
                actionHeader.innerHTML = `
                    <strong style="color: #aaa; font-size: 0.8em; cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">
                        üîÑ –°–ª–µ–¥—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ (–∫–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)
                    </strong>
                    <div style="display: none; margin-top: 5px; color: #bbb; font-size: 0.85em; padding: 5px; background: #333; border-radius: 3px;">
                        ${nextAction}
                    </div>
                `;
                expandDiv.appendChild(actionHeader);
            }

            div.appendChild(expandDiv);
        }

        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return div;
    }

    // Show specific stage
    function showStage(stage) {
        currentStage = stage;

        // Hide all stages
        document.getElementById('interview-stage').classList.add('hidden');
        document.getElementById('parsing-stage').classList.add('hidden');
        document.getElementById('results-stage').classList.add('hidden');

        // Show current stage
        document.getElementById(`${stage}-stage`).classList.remove('hidden');

        // Update current state display
        const stageNames = {
            'interview': '–∏–Ω—Ç–µ—Ä–≤—å—é',
            'parsing': '—Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö',
            'results': '–∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤'
        };

        if (currentStateElement) {
            currentStateElement.textContent = `–°—Ç–∞–¥–∏—è: ${stageNames[stage] || stage}`;
        }
    }

    // Send message handler
    async function sendMessage() {
        const txt = inp.value.trim();
        if (!txt) return;

        inp.value = '';
        inp.disabled = true;
        sendBtn.disabled = true;

        // Add user message
        addMsg('user', txt);
        deepHistory.push({role: "user", content: txt});

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
        await createNewChatIfNeeded();

        // Check if user is confirming schema (natural language confirmation)
        const lowerTxt = txt.toLowerCase();
        const schemaConfirmationKeywords = ['–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é', '–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å', '–¥–∞', '–≤–µ—Ä–Ω–æ', '—Å–æ–≥–ª–∞—Å–µ–Ω', 'ok', 'okay', '–ø—Ä–∏–Ω—è—Ç–æ'];
        const containsConfirmation = schemaConfirmationKeywords.some(keyword => lowerTxt.includes(keyword));

        // Check if user wants to modify schema
        const schemaModificationKeywords = ['–∏–∑–º–µ–Ω–∏—Ç—å', '–ø–æ–º–µ–Ω—è—Ç—å', '—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å', '–Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç', '–Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å', '–¥—Ä—É–≥–æ–µ'];
        const containsModification = schemaModificationKeywords.some(keyword => lowerTxt.includes(keyword));

        try {
            // If user is confirming schema, send schema agreement request
            if (containsConfirmation && !containsModification) {
                // Find the last schema in the conversation to confirm
                const lastSchemaMessage = findLastSchemaMessage();

                if (lastSchemaMessage) {
                    // Send schema agreement request
                    const schemaAgreementRes = await fetch('/api/deep_research/schema_agreement', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            search_id: deepSearchId,
                            schema_agreed: lastSchemaMessage // Assuming this is the JSON schema
                        })
                    });
                    const schemaAgreementData = await schemaAgreementRes.json();

                    if (schemaAgreementData.status === 'success') {
                        // Move to parsing stage
                        showStage('parsing');

                        // Start parsing
                        startParsingPhase();

                        // Add confirmation message to chat
                        addMsg('assistant', '‚úÖ –°—Ö–µ–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö...');
                        return;
                    }
                }
            }

            const res = await fetch('/api/deep_research/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    history: deepHistory
                })
            });
            const data = await res.json();

            if (data.type === 'interview') {
                // Add bot response with reasoning, internal thoughts and next action
                addMsg('assistant', marked.parse(data.message), true, data.reasoning, data.internal_thoughts, data.next_action || '');
                deepHistory.push({role: "assistant", content: data.message});

                // Store search ID
                if (data.search_id) {
                    deepSearchId = data.search_id;
                }

                // Check if schema was proposed in the response
                if (data.schema_proposal) {
                    // Save the proposed schema for later confirmation
                    window.lastProposedSchema = data.schema_proposal;

                    // Parse the schema to create a human-readable explanation
                    try {
                        const schemaObj = JSON.parse(data.schema_proposal);

                        // Create a human-readable explanation of the schema
                        let schemaExplanation = "üìã –Ø –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª —Å—Ö–µ–º—É –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏–π:\n\n";

                        if (schemaObj.name) {
                            schemaExplanation += `**–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã:** ${schemaObj.name}\n\n`;
                        }

                        if (schemaObj.description) {
                            schemaExplanation += `**–û–ø–∏—Å–∞–Ω–∏–µ:** ${schemaObj.description}\n\n`;
                        }

                        schemaExplanation += "**–ü–æ–ª—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:**\n";
                        if (schemaObj.properties) {
                            for (const [key, property] of Object.entries(schemaObj.properties)) {
                                schemaExplanation += `- **${key}**: ${property.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'} (—Ç–∏–ø: ${property.type})\n`;
                            }
                        }

                        schemaExplanation += "\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å—Ö–µ–º—É, –Ω–∞–ø–∏—Å–∞–≤ '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é', '–¥–∞' –∏–ª–∏ '—Å–æ–≥–ª–∞—Å–µ–Ω'. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å - –Ω–∞–ø–∏—à–∏—Ç–µ –æ–± —ç—Ç–æ–º.";

                        // Add the schema explanation to the chat with reasoning, internal thoughts and next action
                        addMsg('assistant', marked.parse(schemaExplanation), true, data.reasoning, data.internal_thoughts, data.next_action || '');
                    } catch (parseErr) {
                        console.error("Error parsing schema:", parseErr);
                        // If parsing fails, just show the raw JSON
                        addMsg('assistant', `üìã –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–∞—è —Å—Ö–µ–º–∞ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON):\n\`\`\`json\n${data.schema_proposal}\n\`\`\`\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å—Ö–µ–º—É, –Ω–∞–ø–∏—Å–∞–≤ '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é', '–¥–∞' –∏–ª–∏ '—Å–æ–≥–ª–∞—Å–µ–Ω'.`, false, data.reasoning, data.internal_thoughts, data.next_action || '');
                    }
                }

                // Check if we can move to next stage
                if (!data.needs_more_info && !data.error) {
                    // The model will now include schema proposal in its response
                    // No need to call generateAndShowSchemaProposal separately
                }
                // If there's an error (like LLM unavailable), don't proceed to next stage
                else if (data.error) {
                    // Disable input to prevent further attempts
                    inp.disabled = true;
                    sendBtn.disabled = true;
                    finishInterviewBtn.disabled = true;

                    // Show error message with reasoning, internal thoughts and next action
                    addMsg('assistant', `‚ùå ${data.error}`, false, data.reasoning, data.internal_thoughts, data.next_action || '');
                }
            }
            else if (data.type === 'schema_confirmed') {
                // Handle schema confirmation with reasoning, internal thoughts and next action
                addMsg('assistant', marked.parse(data.message), true, data.reasoning, data.internal_thoughts, data.next_action || '');

                // Update search ID if needed
                if (data.search_id) {
                    deepSearchId = data.search_id;
                }

                // Move to parsing stage
                showStage('parsing');

                // Start parsing
                startParsingPhase();
            }

            // –ï—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å —Ç–µ–∫—É—â–∏–π —á–∞—Ç, –¥–æ–±–∞–≤–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –Ω–µ–≥–æ
            if (currentChatId) {
                try {
                    await fetch(`/api/chats/${currentChatId}/messages`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            role: "assistant",
                            content: data.message || data.summary || '–°–æ–æ–±—â–µ–Ω–∏–µ',
                            message_type: data.type || "interview_response"
                        })
                    });
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç:', err);
                }
            }
        } catch (err) {
            console.error(err);
            addMsg('assistant', '‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', false, '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'retry_connection');
        }

        inp.disabled = false;
        sendBtn.disabled = false;
    }

    // Helper function to find the last schema message in the conversation
    function findLastSchemaMessage() {
        // Look for the last message that contains a schema
        // This would need to be implemented based on how the schema is stored/retrieved
        // For now, we'll store the last proposed schema in a variable
        return window.lastProposedSchema || null;
    }

    // This function is no longer used as schema proposal is now included in the interview response
    // The schema is generated and presented by the LLM when it determines sufficient information has been gathered

    // Event listeners
    sendBtn.addEventListener('click', sendMessage);

    inp.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    finishInterviewBtn.addEventListener('click', async () => {
        // Add user message indicating interview is finished
        addMsg('user', '–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é');
        deepHistory.push({role: "user", content: "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é"});

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏–Ω—Ç–µ—Ä–≤—å—é
        await createNewChatIfNeeded();

        // Send the message to the server to continue the interview process
        try {
            const res = await fetch('/api/deep_research/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    history: deepHistory
                })
            });
            const data = await res.json();

            if (data.type === 'interview') {
                // Add bot response with reasoning, internal thoughts and next action
                addMsg('assistant', marked.parse(data.message), true, data.reasoning, data.internal_thoughts, data.next_action || '');
                deepHistory.push({role: "assistant", content: data.message});

                // Store search ID
                if (data.search_id) {
                    deepSearchId = data.search_id;
                }

                // Check if schema was proposed in the response
                if (data.schema_proposal) {
                    // Save the proposed schema for later confirmation
                    window.lastProposedSchema = data.schema_proposal;

                    // Parse the schema to create a human-readable explanation
                    try {
                        const schemaObj = JSON.parse(data.schema_proposal);

                        // Create a human-readable explanation of the schema
                        let schemaExplanation = "üìã –Ø –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª —Å—Ö–µ–º—É –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏–π:\n\n";

                        if (schemaObj.name) {
                            schemaExplanation += `**–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã:** ${schemaObj.name}\n\n`;
                        }

                        if (schemaObj.description) {
                            schemaExplanation += `**–û–ø–∏—Å–∞–Ω–∏–µ:** ${schemaObj.description}\n\n`;
                        }

                        schemaExplanation += "**–ü–æ–ª—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:**\n";
                        if (schemaObj.properties) {
                            for (const [key, property] of Object.entries(schemaObj.properties)) {
                                schemaExplanation += `- **${key}**: ${property.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'} (—Ç–∏–ø: ${property.type})\n`;
                            }
                        }

                        schemaExplanation += "\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å—Ö–µ–º—É, –Ω–∞–ø–∏—Å–∞–≤ '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é', '–¥–∞' –∏–ª–∏ '—Å–æ–≥–ª–∞—Å–µ–Ω'. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å - –Ω–∞–ø–∏—à–∏—Ç–µ –æ–± —ç—Ç–æ–º.";

                        // Add the schema explanation to the chat with reasoning, internal thoughts and next action
                        addMsg('assistant', marked.parse(schemaExplanation), true, data.reasoning, data.internal_thoughts, data.next_action || '');
                    } catch (parseErr) {
                        console.error("Error parsing schema:", parseErr);
                        // If parsing fails, just show the raw JSON
                        addMsg('assistant', `üìã –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–∞—è —Å—Ö–µ–º–∞ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON):\n\`\`\`json\n${data.schema_proposal}\n\`\`\`\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å—Ö–µ–º—É, –Ω–∞–ø–∏—Å–∞–≤ '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é', '–¥–∞' –∏–ª–∏ '—Å–æ–≥–ª–∞—Å–µ–Ω'.`, false, data.reasoning, data.internal_thoughts, data.next_action || '');
                    }
                }
            }
        } catch (err) {
            console.error(err);
            addMsg('assistant', '‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', false, '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'retry_connection');
        }
    });

    confirmSchemaBtn.addEventListener('click', async () => {
        const schemaJson = schemaEditor.value;

        try {
            // Validate JSON
            JSON.parse(schemaJson);

            const res = await fetch('/api/deep_research/schema_agreement', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    search_id: deepSearchId,
                    schema_agreed: schemaJson
                })
            });
            const data = await res.json();

            if (data.status === 'success') {
                // Move to parsing stage
                showStage('parsing');

                // Start parsing
                startParsingPhase();
            }
        } catch (err) {
            console.error(err);
            alert('–û—à–∏–±–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON');
        }
    });

    backToInterviewBtn.addEventListener('click', () => {
        showStage('interview');
    });

    skipParsingBtn.addEventListener('click', () => {
        // Skip directly to analysis
        showStage('results');
        fetchAnalysisResults();
    });

    // Start parsing phase
    async function startParsingPhase() {
        try {
            const res = await fetch(`/api/deep_research/start_parsing?search_id=${deepSearchId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            const data = await res.json();

            // Simulate parsing progress
            simulateParsingProgress();
        } catch (err) {
            console.error(err);
        }
    }

    // Simulate parsing progress
    function simulateParsingProgress() {
        let count = 0;
        const target = 200;
        const interval = setInterval(() => {
            if (count < target) {
                count += Math.floor(Math.random() * 10) + 1; // Random increment
                if (count > target) count = target;

                const percent = (count / target) * 100;
                parsingProgressFill.style.width = `${percent}%`;
                parsedCountSpan.textContent = count;
            } else {
                clearInterval(interval);
                // Move to analysis after "parsing" is complete
                setTimeout(() => {
                    showStage('results');
                    fetchAnalysisResults();
                }, 1000);
            }
        }, 500);
    }

    // Fetch analysis results
    async function fetchAnalysisResults() {
        try {
            const res = await fetch(`/api/deep_research/execute_analysis?search_id=${deepSearchId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            const data = await res.json();

            if (data.status === 'completed') {
                // Get the search session to retrieve the summary and reasoning
                const sessionRes = await fetch(`/api/searches/${deepSearchId}/status`);
                const sessionData = await sessionRes.json();

                if (sessionData.summary) {
                    // Create detailed analysis view with reasoning and internal thoughts
                    let detailedAnalysis = marked.parse(sessionData.summary);

                    // Add reasoning and internal thoughts if available
                    if (sessionData.reasoning || sessionData.internal_thoughts) {
                        detailedAnalysis += `
                            <div style="margin-top: 20px; padding: 15px; background: #2a2a2a; border-radius: 8px; border-left: 3px solid #666;">
                                <h4 style="color: #ccc; margin-top: 0;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h4>

                                ${sessionData.reasoning ? `
                                <div style="margin-bottom: 15px;">
                                    <strong style="color: #aaa; font-size: 0.9em; cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">
                                        üîç –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è (–∫–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)
                                    </strong>
                                    <div style="display: none; margin-top: 5px; color: #bbb; font-size: 0.85em; padding: 10px; background: #333; border-radius: 4px;">
                                        ${sessionData.reasoning}
                                    </div>
                                </div>` : ''}

                                ${sessionData.internal_thoughts ? `
                                <div style="margin-bottom: 15px;">
                                    <strong style="color: #aaa; font-size: 0.9em; cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">
                                        üí≠ –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è (–∫–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)
                                    </strong>
                                    <div style="display: none; margin-top: 5px; color: #bbb; font-size: 0.85em; padding: 10px; background: #333; border-radius: 4px;">
                                        ${sessionData.internal_thoughts}
                                    </div>
                                </div>` : ''}
                            </div>
                        `;
                    }

                    analysisSummary.innerHTML = detailedAnalysis;
                } else {
                    analysisSummary.innerHTML = '<p>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ–∑–∂–µ.</p>';
                }

                // Get the items
                const itemsRes = await fetch(`/api/searches/${deepSearchId}/items`);
                const items = await itemsRes.json();

                renderTopItemsGrid(items.slice(0, 20)); // Top 20 items

                // –ï—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å —Ç–µ–∫—É—â–∏–π —á–∞—Ç, –¥–æ–±–∞–≤–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –Ω–µ–≥–æ
                if (currentChatId) {
                    try {
                        await fetch(`/api/chats/${currentChatId}/messages`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                role: "assistant",
                                content: sessionData.summary,
                                message_type: "analysis_result"
                            })
                        });
                    } catch (err) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç:', err);
                    }
                }
            }
        } catch (err) {
            console.error(err);
            analysisSummary.innerHTML = '<p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞.</p>';
        }
    }

    // Render top items grid
    function renderTopItemsGrid(items) {
        if (items.length === 0) {
            topItemsGrid.innerHTML = '<div style="color: #555; text-align: center; margin: 50px auto;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
            return;
        }

        topItemsGrid.innerHTML = items.map(item => {
            let specsHtml = '';
            if (item.structured_data) {
                try {
                    const sd = JSON.parse(item.structured_data);
                    // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 3 –ø–æ–ª—è –¥–ª—è –ø—Ä–µ–≤—å—é
                    specsHtml = Object.entries(sd)
                        .slice(0, 3)
                        .map(([k, v]) => `<div><b>\${k}:</b> \${v}</div>`)
                        .join('');
                } catch(e) {}
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º—ã—Å–ª–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            let reasoningHtml = '';
            if (item.reasoning || item.internal_thoughts) {
                reasoningHtml = `
                    <div style="margin-top: 8px; padding: 8px; background: #2a2a2a; border-radius: 4px; border-left: 2px solid #666;">
                        ${item.reasoning ? `
                        <div style="margin-bottom: 5px;">
                            <strong style="color: #aaa; font-size: 0.75em; cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">
                                üîç –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ (–∫–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)
                            </strong>
                            <div style="display: none; margin-top: 3px; color: #bbb; font-size: 0.75em; padding: 5px; background: #333; border-radius: 3px;">
                                \${item.reasoning}
                            </div>
                        </div>` : ''}

                        ${item.internal_thoughts ? `
                        <div style="margin-bottom: 5px;">
                            <strong style="color: #aaa; font-size: 0.75em; cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">
                                üí≠ –†–∞–∑–º—ã—à–ª–µ–Ω–∏—è (–∫–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)
                            </strong>
                            <div style="display: none; margin-top: 3px; color: #bbb; font-size: 0.75em; padding: 5px; background: #333; border-radius: 3px;">
                                \${item.internal_thoughts}
                            </div>
                        </div>` : ''}
                    </div>
                `;
            }

            return `
            <div class="card" style="background: #1e1e1e; border: 1px solid #333; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s;">
                <img src="\${item.image_url || 'https://via.placeholder.com/200x140?text=No+Photo'}" style="width: 100%; height: 140px; object-fit: cover; background: #252525;">
                <div class="card-body" style="padding: 12px; flex: 1; display: flex; flex-direction: column;">
                    <div class="price" style="color: #4CAF50; font-weight: bold; font-size: 1.1rem; margin-bottom: 5px;">\${item.price}</div>
                    <div class="title" style="color: #e0e0e0; text-decoration: none; font-size: 0.9rem; font-weight: 500; display: block; line-height: 1.3; margin-bottom: 8px;"><a href="\${item.url}" target="_blank" style="color: #e0e0e0; text-decoration: none;">\${item.title}</a></div>
                    <div class="specs" style="font-size: 0.75rem; color: #888; margin-top: auto; border-top: 1px solid #333; padding-top: 8px;">\${specsHtml}</div>
                    \${reasoningHtml}
                </div>
            </div>
            `;
        }).join('');
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞
    window.onload = function() {
        addMsg('bot', '–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –≤–∞–º –ø—Ä–æ–≤–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞. –û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –º–æ–∏ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã —è –º–æ–≥ –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å –≤–∞—à–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏.');
    };
</script>
{% endblock %}