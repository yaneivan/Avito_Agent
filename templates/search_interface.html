{% extends "base.html" %}
{% block title %}Avito Agent - –ü–æ–∏—Å–∫{% endblock %}
{% block content %}
<div class="container" style="padding: 0;">
    <div id="chat-container" style="display: flex; flex-direction: column; background: #1a1a1a; border-radius: 8px; overflow: hidden; height: 60vh; border: 1px solid #333;">
        <div id="chat-header" style="padding: 15px 20px; background: #222; border-bottom: 1px solid #333; font-weight: bold;">–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</div>
        <div id="chat-window" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px;"></div>
        <div id="input-area" style="padding: 20px; border-top: 1px solid #333;">
            <input type="text" id="inp" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å..." style="width: 100%; padding: 12px; background: #2d2d2d; border: 1px solid #444; border-radius: 6px; color: white; outline: none;">
        </div>
    </div>
    <div id="main" style="margin-top: 20px; background: #1a1a1a; border-radius: 8px; border: 1px solid #333;">
        <div id="status-bar" style="padding: 10px 20px; color: #4CAF50; display: none;"><i class="fas fa-sync fa-spin me-2"></i><span>–û–∂–∏–¥–∞–Ω–∏–µ...</span></div>
        <div id="grid" style="padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; min-height: 200px;"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    let taskId = null, history = [], summaryDisplayed = false, pollTimer = null, currentChatId = null;
    const chat = document.getElementById('chat-window'), inp = document.getElementById('inp'), grid = document.getElementById('grid'), statusBar = document.getElementById('status-bar');

    function addMsg(role, text, isHtml = false) {
        const div = document.createElement('div');
        div.style.cssText = `padding: 10px 15px; border-radius: 8px; max-width: 80%; margin-bottom: 10px; ${role === 'user' ? 'background:#2d2d2d; align-self:flex-end;' : 'background:#262626; border-left:3px solid #4CAF50; align-self:flex-start;'}`;
        div.innerHTML = isHtml ? text : text;
        chat.appendChild(div); chat.scrollTop = chat.scrollHeight;
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —á–∞—Ç–∞ –ø–æ chat_id –∏–∑ URL
    async function loadExistingChat() {
        const urlParams = new URLSearchParams(window.location.search);
        const chatIdParam = urlParams.get('chat_id');
        if (chatIdParam) {
            currentChatId = chatIdParam;
            try {
                const res = await fetch(`/api/chats/${currentChatId}`);
                if (res.ok) {
                    const data = await res.json();
                    chat.innerHTML = '';
                    history = [];
                    data.messages.forEach(msg => {
                        if (msg.role !== 'system') {
                            addMsg(msg.role, marked.parse(msg.content), true);
                            history.push({role: msg.role, content: msg.content});
                        }
                    });
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞:', e);
            }
        }
    }

    inp.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter' && inp.value.trim()) {
            const txt = inp.value; inp.value = ''; inp.disabled = true;
            addMsg('user', txt); history.push({role: "user", content: txt});
            if (!currentChatId) {
                const c = await fetch('/api/chats', {method: 'POST'});
                const d = await c.json(); currentChatId = d.id;
                // –û–±–Ω–æ–≤–ª—è–µ–º URL —Å chat_id
                window.history.pushState({}, '', `?chat_id=${currentChatId}`);
            }
            const res = await fetch('/api/agent/chat', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({history})});
            const data = await res.json();
            if (data.type === 'search') {
                addMsg('bot', 'üöÄ ' + data.message); taskId = data.task_id;
                grid.innerHTML = ''; statusBar.style.display = 'block'; summaryDisplayed = false;
                startPolling();
            } else {
                addMsg('bot', marked.parse(data.message), true);
                history.push({role: "assistant", content: data.message});
                inp.disabled = false;
            }
        }
    });

    function startPolling() {
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(async () => {
            const sRes = await fetch(`/api/searches/${taskId}/status`), sData = await sRes.json();
            statusBar.querySelector('span').innerText = sData.status;

            const iRes = await fetch(`/api/searches/${taskId}/items`), items = await iRes.json();
            if (items.length > 0) renderGrid(items); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É!

            if (sData.status === 'done' && sData.summary && !summaryDisplayed) {
                summaryDisplayed = true; clearInterval(pollTimer);
                addMsg('bot', marked.parse(sData.summary), true);
                inp.disabled = false;
            }
        }, 2000);
    }

    function renderGrid(items) {
        grid.innerHTML = items.map(i => `
            <div style="background:#1e1e1e; border:1px solid #333; border-radius:8px; overflow:hidden;">
                <img src="${i.image_url || 'https://via.placeholder.com/150'}" style="width:100%; height:120px; object-fit:cover;">
                <div style="padding:10px;">
                    <div style="color:#4CAF50; font-weight:bold;">${i.price}</div>
                    <div style="font-size:0.85rem; color:#eee; height:2.4em; overflow:hidden;">${i.title}</div>
                </div>
            </div>`).join('');
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    loadExistingChat();
</script>
{% endblock %}