# Avito Agent

Проект представляет собой интеллектуального агента для поиска и глубокого анализа объявлений на платформе Avito. Основная цель — автоматизация сбора данных, извлечение скрытых характеристик из текста и изображений с помощью VLM (Vision Language Model) и объективное ранжирование предложений.

## Архитектура приложения

### Основные сущности

> **Примечание**: Названия "сессия" (в виде ChatSession, DeepResearchSession, SearchSession) являются условными и используются для обозначения долгосрочных записей взаимодействия, а не краткосрочного состояния в традиционном понимании.

#### ChatSession
`ChatSession` - это сессия чата между пользователем и ассистентом. Она представляет собой контейнер для переписки и содержит:

- `id`: Уникальный идентификатор сессии
- `title`: Название сессии (обычно формируется автоматически)
- `created_at`, `updated_at`: Даты создания и последнего обновления
- `messages`: Список сообщений в сессии
- `deep_research_session`: Связь с сессией глубокого исследования (если существует)

Основная функция `ChatSession` - хранить переписку между пользователем и ассистентом.

#### DeepResearchSession
`DeepResearchSession` - это сессия глубокого исследования рынка. Она представляет собой контейнер для всего процесса анализа и содержит:

- `id`: Уникальный идентификатор сессии
- `query_text`: Исходный запрос пользователя
- `status`: Статус выполнения (created, interview, parsing, analysis, completed)
- `stage`: Текущий этап (interview, schema_agreement, parsing, analysis, completed)
- `created_at`, `updated_at`: Даты создания и последнего обновления
- `limit_count`: Ограничение на количество обрабатываемых элементов
- `open_in_browser`, `use_cache`: Настройки выполнения
- `summary`: Сводка результатов анализа
- `reasoning`, `internal_thoughts`: Дополнительная информация от LLM
- `interview_data`, `schema_agreed`: Данные, собранные в процессе исследования
- `analysis_result`: Результаты анализа
- `schema_id`: Ссылка на используемую схему извлечения данных
- `chat_session_id`: Ссылка на связанную чат-сессию
- `items`: Список найденных и проанализированных элементов

Основная функция `DeepResearchSession` - управлять процессом глубокого исследования и хранить его результаты.

#### SearchSession
`SearchSession` - это сессия простого поиска. Используется для быстрых поисковых задач без сложного анализа.

#### Связи между сущностями

- `DeepResearchSession` может быть связана с одной `ChatSession` (один ко многим в обратном направлении)
- `ChatSession` может иметь (или не иметь) связанную `DeepResearchSession`
- Обе сессии могут использовать общую таблицу `SearchItemLink` для связи с найденными элементами
- `Item` может быть связан с обеими сессиями через `SearchItemLink`

### Процессы

#### Глубокое исследование
1. Создается `DeepResearchSession` с начальным статусом
2. Создается `ChatSession` и связывается с `DeepResearchSession`
3. Пользователь взаимодействует с агентом через чат
4. В процессе собирается информация и формируется схема извлечения данных
5. Выполняется анализ и сбор данных
6. Результаты сохраняются в `DeepResearchSession`
7. Результаты отображаются пользователю

#### Простой поиск
1. Создается `SearchSession` для выполнения поиска
2. Выполняется анализ и сбор данных
3. Результаты сохраняются в `SearchSession`