# Avito Agent

Проект представляет собой интеллектуального агента для поиска и глубокого анализа объявлений на платформе Avito. Основная цель — автоматизация сбора данных, извлечение скрытых характеристик из текста и изображений с помощью VLM (Vision Language Model) и объективное ранжирование предложений.

## Используемая модель

Проект использует локальную модель Qwen3-VL-4B-Instruct - мощную визуально-языковую модель, способную анализировать как текст, так и изображения. Модель обладает следующими возможностями:
- Понимание и генерация текста
- Глубокий визуальный анализ и распознавание объектов
- Обработка изображений и видео
- Мультимодальное рассуждение

Однако, как и большинство локальных моделей малого объема, Qwen3-VL-4B-Instruct может вести себя непредсказуемо и требует четких, подробных инструкций и примеров для корректной работы. Иногда модель может игнорировать форматы вывода или генерировать неожиданные ответы, поэтому важно тщательно проверять результаты её работы.

## Архитектура приложения

### Основные сущности

> **Примечание**: Названия "сессия" (в виде ChatSession, DeepResearchSession, SearchSession) являются условными и используются для обозначения долгосрочных записей взаимодействия, а не краткосрочного состояния в традиционном понимании.

#### ChatSession
`ChatSession` - это сессия чата между пользователем и ассистентом. Она представляет собой контейнер для переписки и содержит:

- `id`: Уникальный идентификатор сессии
- `title`: Название сессии (обычно формируется автоматически)
- `created_at`, `updated_at`: Даты создания и последнего обновления
- `messages`: Список сообщений в сессии
- `deep_research_session`: Связь с сессией глубокого исследования (если существует)

Основная функция `ChatSession` - хранить переписку между пользователем и ассистентом.

#### DeepResearchSession
`DeepResearchSession` - это сессия глубокого исследования рынка. Она представляет собой контейнер для всего процесса анализа и содержит:

- `id`: Уникальный идентификатор сессии
- `query_text`: Исходный запрос пользователя
- `status`: Статус выполнения (created, interview, parsing, analysis, completed)
- `stage`: Текущий этап (interview, schema_agreement, parsing, analysis, completed)
- `created_at`, `updated_at`: Даты создания и последнего обновления
- `limit_count`: Ограничение на количество обрабатываемых элементов
- `open_in_browser`, `use_cache`: Настройки выполнения
- `summary`: Сводка результатов анализа
- `reasoning`, `internal_thoughts`: Дополнительная информация от LLM
- `interview_data`, `schema_agreed`: Данные, собранные в процессе исследования
- `analysis_result`: Результаты анализа
- `schema_id`: Ссылка на используемую схему извлечения данных
- `chat_session_id`: Ссылка на связанную чат-сессию
- `items`: Список найденных и проанализированных элементов

Основная функция `DeepResearchSession` - управлять процессом глубокого исследования и хранить его результаты.

#### SearchSession
`SearchSession` - это сессия простого поиска. Используется для быстрых поисковых задач без сложного анализа.

#### Связи между сущностями

- `DeepResearchSession` может быть связана с одной `ChatSession` (один ко многим в обратном направлении)
- `ChatSession` может иметь (или не иметь) связанную `DeepResearchSession`
- Обе сессии могут использовать общую таблицу `SearchItemLink` для связи с найденными элементами
- `Item` может быть связан с обеими сессиями через `SearchItemLink`

### Процессы

#### Глубокое исследование
1. Создается `DeepResearchSession` с начальным статусом
2. Создается `ChatSession` и связывается с `DeepResearchSession`
3. Пользователь взаимодействует с агентом через чат
4. В процессе собирается информация и формируется схема извлечения данных
5. Выполняется анализ и сбор данных
6. Результаты сохраняются в `DeepResearchSession`
7. Результаты отображаются пользователю

Режим "Deep Research" реализован в несколько фаз для обеспечения максимальной точности при работе с локальными моделями малого объема.

**Фаза А: Умное интервью и Summarization**

LLM опрашивает пользователя, пока не будут определены категория и бюджет.

1. Пользователь начинает сессию глубокого исследования
2. Агент проводит интервью, чтобы понять требования (товар и бюджет)
3. Чтобы избежать потери информации при обрезке контекста (Window Limiting), используется поле interview_data, куда записывается суммаризированный список требований, передаваемый в каждый новый запрос

*Примечание: В текущей реализации автоматическое обновление interview_data в процессе диалога не реализовано.*

#### Простой поиск
1. Создается `SearchSession` для выполнения поиска
2. Выполняется анализ и сбор данных
3. Результаты сохраняются в `SearchSession`

### core/
Директория с ядром системы:

#### core/repositories.py
Слой доступа к данным. Содержит репозитории для работы с базой данных:
- ItemRepository - для работы с товарами
- SearchSessionRepository - для работы с сессиями поиска
- SearchItemLinkRepository - для работы со связями между сессиями и товарами
- ExtractionSchemaRepository - для работы со схемами извлечения данных

#### core/services.py
Слой бизнес-логики. Содержит сервисы для обработки данных:
- ItemProcessingService - для обработки товаров
- SearchResultService - для работы с результатами поиска
- ProcessingService - для обработки входящих данных
- ChatProcessingService - для обработки чат-сообщений

### Браузерное расширение

Браузерное расширение автоматизирует сбор данных с сайта Avito и взаимодействует с сервером следующим образом:

1. Периодически опрашивает сервер по адресу `/api/get_task` для получения новых задач
2. При получении задачи открывает вкладку Avito с указанным запросом
3. Запускает парсинг страницы, собирая информацию о товарах (название, цена, URL, описание, изображения)
4. Отправляет собранные данные на сервер через `/api/submit_results`
5. Закрывает вкладку после завершения сбора данных

Расширение извлекает следующую информацию из объявлений:
- Название товара
- Цена
- URL-адрес объявления
- Описание товара
- Изображения товара (конвертированные в формат base64)

Расширение НЕ извлекает:
- Контактную информацию продавца
- Историю просмотров
- Отзывы и рейтинги продавцов
- Дополнительные детали, доступные только после перехода на страницу товара
- Характеристики товара (расширение передает только базовую информацию)

Характеристики товара извлекаются на сервере с помощью VLM (Vision Language Model) на основе:
- Названия товара
- Описания
- Изображений
- Специфической схемы извлечения данных, определенной в процессе глубокого исследования

Расширение использует различные техники для эффективного сбора данных:
- Плавный скроллинг страницы для загрузки новых объявлений
- Анализ DOM-элементов для извлечения информации
- Конвертация изображений в формат base64 для передачи на сервер
- Подсветка обработанных элементов для визуального контроля