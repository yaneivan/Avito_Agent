# TODO List для проекта Avito Agent

## Архитектурные улучшения

### 1. Рефакторинг файла services/processing.py
**Описание:** Разделить файл на слои: слой доступа к данным и слой бизнес-логики
**Статус:** Завершено
**Прогресс:**
- Создан core/repositories.py для работы с базой данных
- Создан core/services.py для бизнес-логики
- Перенесена полная логика из старого processing.py в новые файлы
- Обновлены роутеры для использования новых сервисов
- Обновлены тесты для работы с новыми сервисами
- Старый файл services/processing.py удален
- Директория services переименована в core
**Результат:** Четкое разделение ответственности между уровнями приложения

## Приоритет: Высокий

### 2. Проблема с извлечением характеристик по согласованной схеме
**Описание:** В текущей реализации может не происходить корректное извлечение характеристик по согласованной схеме, несмотря на то, что в коде есть логика для использования динамической схемы.
**Файл:** llm_engine.py, services/processing.py
**Функции:** extract_product_features, process_incoming_data
**Проблема:** Характеристики у товаров не заполняются или заполняются частично
**Статус:** Требуется диагностика
**Диагностика:** Проверить, что схема корректно сохраняется в сессии и передается в extract_product_features

### 3. Непредсказуемое поведение при обработке объявлений с несколькими товарами
**Описание:** Когда в одном объявлении содержится несколько товаров, система ведет себя непредсказуемо.
**Файл:** llm_engine.py
**Функции:** extract_product_features
**Проблема:** Неясно, как выбирать характеристики основного товара или самого дорогого
**Статус:** Не решено

## Приоритет: Средний

### 4. Улучшение логики фильтрации товаров по relevance_score
**Описание:** В текущей реализации товары с relevance_score >= 1 проходят фильтрацию, но это может приводить к потере потенциально подходящих товаров.
**Файл:** services/processing.py
**Функции:** process_incoming_data
**Проблема:** Неправильная фильтрация может привести к потере данных
**Статус:** Не решено

### 5. Улучшение турнирного ранжирования
**Описание:** Турнирное ранжирование реализовано, но не всегда работает должным образом.
**Файл:** llm_engine.py, services/processing.py
**Функции:** tournament_ranking, process_incoming_data
**Проблема:** При малом количестве товаров турнир может не запускаться
**Статус:** Не решено

## Приоритет: Низкий

### 6. Улучшение обработки ошибок в процессе анализа
**Описание:** При ошибках VLM-анализа статус не всегда корректно обновляется.
**Файл:** services/processing.py
**Функции:** process_incoming_data
**Проблема:** Пользователь может не получать результаты при ошибках
**Статус:** Не решено

### 7. Передача visual_notes в турнирное ранжирование
**Описание:** В README упоминается необходимость передачи visual_notes из этапа экстракции в этап турнирное ранжирование.
**Файл:** llm_engine.py, services/processing.py
**Функции:** tournament_ranking
**Проблема:** В текущей реализации эти заметки не используются в турнирном ранжировании
**Статус:** Не решено