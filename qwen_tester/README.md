# Инструмент тестирования Avito Agent

Этот инструмент позволяет тестировать приложение Avito Agent через командную строку, отправляя сообщения на сервер и управляя историей чата.

## Установка

Убедитесь, что у вас установлен Python 3 и библиотека `requests`:

```bash
pip install requests
```

## Подготовка к тестированию

1. Убедитесь, что сервер Avito Agent запущен
2. По умолчанию инструмент ожидает сервер на `http://localhost:8000/api/deep_research/chat`
3. Если сервер запущен на другом порту (например, 8001), используйте опцию `--server-url`

## Использование

### Отправка сообщения серверу

```bash
python chat_client.py "Ваше сообщение здесь"
```

Пример:
```bash
python chat_client.py "Хочу найти хороший смартфон"
```

### Указание другого URL сервера

Если сервер запущен на другом порту (например, 8001):

```bash
python chat_client.py --server-url "http://localhost:8001/api/deep_research/chat" "Ваше сообщение"
```

### Просмотр текущей истории чата

```bash
python chat_client.py --view
```

### Сброс истории чата

```bash
python chat_client.py --reset
```

### Использование сессии чата в базе данных

По умолчанию инструмент создает новую сессию чата в базе данных при каждом запуске. Вы можете использовать существующую сессию, указав её ID:

```bash
python chat_client.py --db-chat-id 1 "Ваше сообщение"
```

## Функциональность

- Автоматическое сохранение истории чата в файл `chat_history.json` внутри папки qwen_tester
- Вывод детализированного ответа сервера с информацией о типе, этапе, обосновании и внутренних мыслях
- Поддержка всех этапов взаимодействия с агентом (интервью, согласование схемы, парсинг, анализ)
- Возможность сброса истории для начала новой сессии
- Автоматическое создание сессии чата в базе данных и сохранение сообщений в таблицах `ChatSession` и `ChatMessage`
- Возможность указания конкретной сессии чата в базе данных с помощью параметра `--db-chat-id`

## Примеры сессии тестирования

1. Запуск сервера Avito Agent (в отдельном терминале):
```bash
python server.py
```

2. Начало тестирования (предполагая, что сервер на порту 8001):
```bash
python chat_client.py --server-url "http://localhost:8001/api/deep_research/chat" "Привет, я хочу найти хороший смартфон"
```

3. Продолжение сессии с дополнительными деталями:
```bash
python chat_client.py --server-url "http://localhost:8001/api/deep_research/chat" "Бюджет до 50000 рублей, процессор не ниже Snapdragon 700 серии"
```

4. Продолжение с другими характеристиками:
```bash
python chat_client.py --server-url "http://localhost:8001/api/deep_research/chat" "Хорошая камера, поддержка 5G, экран AMOLED"
```

5. Просмотр текущего состояния сессии:
```bash
python chat_client.py --view
```

## Заметки для тестирования

- История чата сохраняется в формате JSON в файл `chat_history.json`
- При каждом сообщении вся история отправляется на сервер, как того требует архитектура приложения
- Инструмент автоматически добавляет временные метки к сообщениям
- Ответ сервера содержит важную информацию:
  - `type`: тип ответа (interview, schema_agreement, parsing, analysis)
  - `stage`: текущий этап (interview, schema_agreement, parsing, analysis)
  - `reasoning`: обоснование решения агента
  - `internal_thoughts`: внутренние мысли агента
  - `search_id`: идентификатор текущего поиска

## Тестирование разных сценариев

Для тестирования нового сценария рекомендуется сбросить историю:

```bash
python chat_client.py --reset
python chat_client.py --server-url "http://localhost:8001/api/deep_research/chat" "Новый запрос..."
```

## Возможные проблемы

- Если сервер не запущен, инструмент выдаст ошибку подключения
- Если используется неверный URL, инструмент также выдаст ошибку
- Убедитесь, что используете правильный эндпоинт (обычно `/api/deep_research/chat`)
- После внесения изменений в логику сервера (например, в промпты LLM) может потребоваться перезапуск сервера
- Для перезапуска сервера можно использовать скрипт `restart_server.bat` в корневой директории проекта

## Выводы и наблюдения

При тестировании агента были выявлены следующие особенности:

1. **Проблема с зацикливанием**: До изменений агент мог зацикливаться на одних и тех же вопросах, особенно когда пользователь уже предоставил всю необходимую информацию, но LLM не распознавала, что информации достаточно.

2. **Необходимость четких критериев завершения интервью**: Важно, чтобы LLM имела четкие критерии для определения момента, когда собрана вся необходимая информация для перехода к следующему этапу.

3. **Проблема с обрезанием истории**: Хотя в текущей реализации берутся последние 5 сообщений из истории, этого обычно достаточно для контекста, но в некоторых случаях может быть полезно увеличить это число.

4. **Важность корректного обновления состояния**: Необходимо правильно сохранять и обновлять состояние сессии, особенно при переходе между этапами (interview → schema_agreement → parsing → analysis).

5. **Роль ключевых слов подтверждения**: Для корректного перехода к следующему этапу важно, чтобы пользователь использовал ключевые слова подтверждения (например, "да", "подтверждаю", "верно"), которые распознаются системой.

6. **Необходимость перезапуска сервера после изменений**: После внесения изменений в логику работы LLM (например, в промпты) обязательно требуется перезапуск сервера для применения изменений.

Эти наблюдения помогли улучшить промпты и логику работы агента, сделав его более эффективным в сборе информации и переходе между этапами.